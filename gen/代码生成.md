---
typora-copy-images-to: image
---

# 代码生成

使用了LLVM库，将 AST 转化为 LLVM IR 中间代码。

为了实现 AST 到中间代码的转换，需要维护一个运行环境，维护当前的变量，函数等信息。



## LLVM

LLVM 的核心设计了一个叫 **LLVM IR** 的中间代码， 并以 **库(Library)** 的方式提供一系列接口， 提供生成、操作IR，生成目标平台代码等功能。

![WeChat Screenshot_20200520130516](/image/WeChat Screenshot_20200520130516.png)

LLVM IR 有三种不同的形式：内存中的编译中间语言（IR），保存在硬盘上的 bitcode（`.bc` 文件，适合快速地被一个 JIT 编译器加载），一个可读性的汇编语言表示 (`.ll` 文件)。LLVM项目提供不同代码之间的相互转换。

从  AST 到 LLVM IR 的部分主要使用了 <llvm/IR/...> 中的内容，简单介绍如下

### Module

LLVM 程序由 Module 组成，每个程序模块都是输入程序的翻译单元。每个模块由函数，全局变量和符号表条目组成。

在项目中，实现对简单单文件程序的编译，我们创建一个 Module 完成整个编译工作。

首先在 Module 中创建函数，再往函数中放入表达式的 IR，最后将所有的 IR 输出。

### Function

LLVM 中的函数指针主要有两个部分：函数类型和函数体

函数类型主要表示函数的输入和输出，可以使用 FunctionType 类型

函数体由 BasicBlock 构成，通过 Builder往 BasicBlock 中加入 IR

### BasicBlock

IR是一种抽象的汇编语言，它使用有条件和无条件的跳转（称为分支）来表示控制流。分支之间的依次运行的代码序列称为 BasicBlock，或简称为块。

### IRBuilder

用于创建指令并将其附加到块末尾的便捷接口，其中提供了多种不同的指令

### Value

value 类用来 LLVM 中的表示具有类型的值。在表达式代码生成时通过传递 value 表示变量。



## 环境维护

/gen/...



 